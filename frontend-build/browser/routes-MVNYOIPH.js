import{a as $}from"./chunk-EWRSLDPL.js";import{a as N,b as U}from"./chunk-O55CDUTY.js";import{a as F}from"./chunk-6X7BT2W6.js";import{$b as x,Ac as M,Ia as d,Kb as r,Lb as c,Ra as D,Wb as R,_ as O,_b as g,a as k,b as T,da as p,fb as h,gb as _,ib as b,ja as P,jb as w,ka as q,kb as E,la as S,mb as n,nb as e,ob as u,tb as I,w as C,xb as y,xc as L,zb as f}from"./chunk-APGJX63Q.js";var B=(()=>{let o=class o{constructor(){this.http=p(L),this.tasksUrl=M.apiUrl+M.tasks,this.schedulesUrl=this.tasksUrl+"schedules",this.queueUrl=this.tasksUrl+"queue"}convertTime(t){let i=[{unit:"second",value:60},{unit:"minute",value:60},{unit:"hour",value:24},{unit:"day",value:7}];for(let{unit:l,value:m}of i){if(t<m)return`${t} ${l}${t===1?"":"s"}`;t=Math.floor(t/m)}return`${t} ${t===1?"week":"weeks"}`}convertDate(t){return t?new Date(t+"Z"):null}formatDuration(t){if(t<1)return"00:00:00";let i=Math.floor(t/3600).toString().padStart(2,"0"),l=Math.floor(t%3600/60).toString().padStart(2,"0"),m=(t%60).toString().padStart(2,"0");return`${i}:${l}:${m}`}getScheduledTasks(){return this.http.get(this.schedulesUrl).pipe(C(t=>Object.entries(t).map(([i,l])=>T(k({id:i},l),{interval:this.convertTime(l.interval),last_run_duration:this.formatDuration(l.last_run_duration),last_run_start:this.convertDate(l.last_run_start),next_run:this.convertDate(l.next_run)}))))}getQueuedTasks(){return this.http.get(this.queueUrl).pipe(C(t=>Object.entries(t).map(([i,l])=>T(k({id:i},l),{duration:this.formatDuration(l.duration),finished:this.convertDate(l.finished),started:this.convertDate(l.started)}))))}runScheduledTask(t){return this.http.get(this.tasksUrl+"run/"+t)}};o.\u0275fac=function(i){return new(i||o)},o.\u0275prov=O({token:o,factory:o.\u0275fac,providedIn:"root"});let a=o;return a})();function G(a,o){a&1&&u(0,"app-load-indicator",2)}function H(a,o){if(a&1){let s=I();n(0,"td",11),y("click",function(){P(s);let i=f().$implicit,l=f(2);return i.last_run_status="Running",q(l.runTask(i.task_id))}),S(),n(1,"svg",12),u(2,"path",13),e()()}}function W(a,o){a&1&&(n(0,"td",10),S(),n(1,"svg",14),u(2,"path",15),e()())}function z(a,o){if(a&1&&(n(0,"tr",8)(1,"td",7),r(2),e(),n(3,"td"),r(4),e(),n(5,"td"),r(6),g(7,"timeago"),e(),n(8,"td"),r(9),e(),n(10,"td"),r(11),e(),n(12,"td"),r(13),g(14,"timeago"),e(),h(15,H,3,0,"td",9),h(16,W,3,0,"td",10),e()),a&2){let s=o.$implicit;d(2),c(s.name),d(2),c(s.interval),d(2),c(s.last_run_start?x(7,8,s.last_run_start):"Not run yet"),d(3),c(s.last_run_status),d(2),c(s.last_run_duration),d(2),c(s.next_run?x(14,10,s.next_run):"Not scheduled"),d(2),_(s.last_run_status.toLowerCase()!="running"?15:-1),d(),_(s.last_run_status.toLowerCase()=="running"?16:-1)}}function A(a,o){if(a&1&&(n(0,"div",3)(1,"table",5)(2,"tr",6)(3,"th",7),r(4,"Name"),e(),n(5,"th"),r(6,"Interval"),e(),n(7,"th"),r(8,"Last Run"),e(),n(9,"th"),r(10,"Last Run Status"),e(),n(11,"th"),r(12,"Last Run Duration"),e(),n(13,"th"),r(14,"Next Run"),e(),u(15,"th"),e(),w(16,z,17,12,"tr",8,b),e()()),a&2){let s=f();d(16),E(s.scheduledTasks)}}function J(a,o){a&1&&u(0,"app-load-indicator",2)}function K(a,o){if(a&1&&(n(0,"tr",8)(1,"td",7),r(2),e(),n(3,"td"),r(4),e(),n(5,"td"),r(6),g(7,"timeago"),e(),n(8,"td"),r(9),g(10,"timeago"),e(),n(11,"td"),r(12),e()()),a&2){let s=o.$implicit;d(2),c(s.name),d(2),c(s.status),d(2),c(s.started?x(7,5,s.started):"Pending"),d(3),c(s.finished?x(10,7,s.finished):"-"),d(3),c(s.duration)}}function X(a,o){if(a&1&&(n(0,"div",4)(1,"table",5)(2,"tr",6)(3,"th",7),r(4,"Name"),e(),n(5,"th"),r(6,"Status"),e(),n(7,"th"),r(8,"Started"),e(),n(9,"th"),r(10,"Finished"),e(),n(11,"th"),r(12,"Duration"),e()(),w(13,K,13,9,"tr",8,b),e()()),a&2){let s=f();d(13),E(s.queuedTasks)}}var j=(()=>{let o=class o{constructor(){this.tasksService=p(B),this.websocketService=p($),this.scheduledTasks=[],this.queuedTasks=[],this.isLoading1=!0,this.isLoading2=!0}ngOnInit(){this.refreshTaskData();let t=()=>{this.refreshTaskData()},i=()=>{clearTimeout(this.timeoutRef),this.webSocketSubscription?.unsubscribe()};this.webSocketSubscription=this.websocketService.connect().subscribe({next:t,error:i,complete:i})}getSecondsToNextScheduledEvent(t,i){let l=30;for(let m of i)if(m.status==="Running")return 10;for(let m of t){let Z=new Date().getTime(),Q=m.next_run.getTime(),v=Math.floor((Q-Z)/1e3)+2;if(v=Math.max(v,3),v===3)return 3;l=Math.min(l,v)}return l}refreshTaskData(){clearTimeout(this.timeoutRef),this.tasksService.getScheduledTasks().subscribe(i=>{this.scheduledTasks=i,this.isLoading1=!1}),this.tasksService.getQueuedTasks().subscribe(i=>{this.queuedTasks=i,this.isLoading2=!1});let t=this.getSecondsToNextScheduledEvent(this.scheduledTasks,this.queuedTasks);this.timeoutRef=setTimeout(()=>{this.refreshTaskData()},t*1e3)}ngOnDestroy(){clearTimeout(this.timeoutRef),this.webSocketSubscription?.unsubscribe()}runTask(t){this.tasksService.runScheduledTask(t).subscribe(i=>{console.log(i)})}};o.\u0275fac=function(i){return new(i||o)},o.\u0275cmp=D({type:o,selectors:[["app-tasks"]],features:[R([])],decls:11,vars:2,consts:[[1,"tasks-container"],[1,"text-heading"],[1,"center"],[1,"table-container"],[1,"table-container","last-table"],[1,"tasks-table"],[1,"table-row","header"],[1,"name"],[1,"table-row"],["title","Run task now"],["title","Task is running"],["title","Run task now",3,"click"],["xmlns","http://www.w3.org/2000/svg","viewBox","0 -960 960 960"],["d","M382-306.67 653.33-480 382-653.33v346.66ZM480-80q-82.33 0-155.33-31.5-73-31.5-127.34-85.83Q143-251.67 111.5-324.67T80-480q0-83 31.5-156t85.83-127q54.34-54 127.34-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 82.33-31.5 155.33-31.5 73-85.5 127.34Q709-143 636-111.5T480-80Z"],["xmlns","http://www.w3.org/2000/svg","viewBox","0 -960 960 960",1,"loading"],["d","M343-107q-120-42-194.5-146.5T74-490q0-29 4-57.5T91-604l-57 33-37-62 185-107 106 184-63 36-54-92q-13 30-18.5 60.5T147-490q0 113 65.5 200T381-171l-38 64Zm291-516v-73h107q-47-60-115.5-93.5T480-823q-66 0-123.5 24T255-734l-38-65q54-45 121-71t142-26q85 0 160.5 33T774-769v-67h73v213H634ZM598-1 413-107l107-184 62 37-54 94q123-17 204.5-110.5T814-489q0-19-2.5-37.5T805-563h74q4 18 6 36.5t2 36.5q0 142-87 251.5T578-96l56 33-36 62Z"]],template:function(i,l){i&1&&(n(0,"div",0)(1,"div",1),r(2,"Scheduled"),e(),u(3,"hr"),h(4,G,1,0,"app-load-indicator",2)(5,A,18,0,"div",3),n(6,"div",1),r(7,"Queue"),e(),u(8,"hr"),h(9,J,1,0,"app-load-indicator",2)(10,X,15,0,"div",4),e()),i&2&&(d(4),_(l.isLoading1?4:5),d(5),_(l.isLoading1?9:10))},dependencies:[F,U,N],styles:[".tasks-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding:1rem}@media (width < 765px){.tasks-container[_ngcontent-%COMP%]{padding:.5rem}}.text-heading[_ngcontent-%COMP%]{margin-top:1rem;text-align:left;font-size:2rem}.center[_ngcontent-%COMP%]{margin:auto}.table-container[_ngcontent-%COMP%]{width:100%;overflow-x:auto;min-height:25%;-webkit-overflow-scrolling:touch;margin-top:.5rem;margin-bottom:2rem}.last-table[_ngcontent-%COMP%]{margin-bottom:0}.tasks-table[_ngcontent-%COMP%]{width:100%;max-width:100%;white-space:nowrap;border-collapse:collapse}.tasks-table[_ngcontent-%COMP%]   .table-row[_ngcontent-%COMP%]{border-bottom:1px solid var(--color-outline);white-space:nowrap;text-align:left}.tasks-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .tasks-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:1rem .5rem}.tasks-table[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%]{font-weight:700;border-bottom:2px solid var(--color-outline)}.tasks-table[_ngcontent-%COMP%]   .name[_ngcontent-%COMP%]{width:100%}.table-row[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{margin:0 .5rem;width:1rem;fill:var(--color-primary);cursor:pointer}.loading[_ngcontent-%COMP%]{cursor:progress;animation:spin-animation 2s linear infinite}.table-row[_ngcontent-%COMP%]:hover:not(:first-child){background-color:var(--color-tertiary-container)}"]});let a=o;return a})();var _t=[{path:"",loadComponent:()=>j}];export{_t as default};
